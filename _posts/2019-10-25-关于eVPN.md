---
layout: post
title: 关于eVPN
category : 技术日志
tags : [tech, evpn]
---
>Ethernet Virtual Private Network

>Define by RFC7432（BGP MPLS-Based Ethernet VPN）

## 背景

EVPN继承了MP-BGP和VXLAN的优势。具有如下特点：

简化配置：通过MP-BGP实现VTEP自动发现、VXLAN隧道自动建立、VXLAN隧道与VXLAN自动关联，无需用户手工配置，降低网络部署难度。

分离控制平面与数据平面：控制平面负责发布路由信息，数据平面负责转发报文，分工明确，易于管理。

支持多归属：当同一个站点通过多台VTEP接入VXLAN网络时，连接该站点的多条路径均可以进行流量转发，以提高网络带宽利用率。

支持对称IRB（Integrated Bridging and Routing，集成的桥接和路由）：MP-BGP同时发布二层MAC地址和三层路由信息，VTEP既可以进行二层转发，也可以进行三层路由。这样，不仅可以保证流量采用最优路径转发，还可以减少广播流量。

## 原理
 
定义了一套新的寻址机制，即基于新的NLRI set进行二层路由表构建。

为了不同站点之间可以相互学习对方的MAC信息，因此EVPN在BGP协议的基础上定义了一种新的NLRI（Network Layer Reachability Information，网络层可达信息），被称为EVPN NLRI。在EVPN NLRI中共定义了4种EVPN路由类型：

以太自动发现路由（Ethernet Auto-Discovery route）：当PE之间的BGP邻居关系建立成功后，PE之间会传递以太自动发现路由。以太自动发现路由可以向其他PE通告本端PE对接入站点的MAC地址的可达性，即PE对连接的站点是否可达。以太自动发现路由主要用于快速收敛、冗余模式与别名和水平分割。

![](   https://themeiwu.com/img/tech/tech2020010701.png){: width="800px"}

Route Distinguisher：该字段可以是EVPN实例下设置的RD（Route Distinguisher）值，也可以是由PE上设置的源IP地址组合而成，例如X.X.X.X:0。

Ethernet Segment Identifier：PE与某一CE的连接定义的唯一标识。

Ethernet Tag ID：该字段在以太自动发现路由中为全0或全F。

MPLS Label：该字段为0或者EVPN单播流量负载分担转发时使用的MPLS标签。

MAC地址通告路由（MAC advertisement route）：MAC地址通告路由可以携带本端PE上EVPN实例的RD值、ESI值以及EVPN实例对应的私网标签

![](   https://themeiwu.com/img/tech/tech2020010702.png){: width="800px"}

Route Distinguisher：该字段为EVPN实例下设置的RD（Route Distinguisher）值。

Ethernet Segment Identifier：PE与某一CE的连接定义的唯一标识。

Ethernet Tag ID：PE上实际配置的Vlan ID

MAC Address Length：被该类型路由通告的MAC地址长度。

MAC Address：被该类型路由通告的MAC地址。

IP Address Length：被该类型路由通告的主机IP地址掩码长度。

IP Address ：被该类型路由通告的主机IP地址。

MPLS Label1：二层业务流量转发使用的标签。

MPLS Label2：三层业务流量转发使用的标签。

